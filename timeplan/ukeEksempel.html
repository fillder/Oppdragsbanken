<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../timeplanV2/css/global.css" />
    <link rel="stylesheet" href="../timeplanV2/css/svgikoner.css" />
    <link rel="stylesheet" href="../timeplanV2/css/nav.css" />
    <title>Timeplan uke 36</title>
  </head>
  <style>
    /* STRUKTUR */
    body {
      display: grid;
      grid-template-rows: auto 1fr;
      background-color: var(--clr-bakgrunn);
      color: var(--clr-tekst);
    }
    main {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      background-color: var(--clr-main);
      gap: 0.5rem;
      width: 100%;
      max-width: 1600px;
      margin-inline: auto;
      padding-inline: 1rem;
      padding-block: 0.5rem;
    }
    header {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      padding-top: 70px;
      background-color: var(--clr-main);
      width: 100%;
      max-width: 1600px;
      margin-inline: auto;
      text-align: center;
      gap: 0.5rem;
    }
    #mandag,
    #tirsdag,
    #onsdag,
    #torsdag,
    #fredag {
      display: grid;
      grid-template-rows: repeat(10, 1fr);
      grid-auto-flow: column;
      gap: 0.5rem;
      min-width: 225px;
    }
    .enkel {
      grid-row-end: span 1;
      min-height: 95px;
    }
    .dobbel {
      grid-row-end: span 2;
    }
    .trippel {
      grid-row-end: span 3;
    }
    .firer {
      grid-row-end: span 4;
    }
    .oppstart0815 {
      grid-row-start: 1;
    }
    .oppstart0900 {
      grid-row-start: 2;
    }
    .oppstart0955 {
      grid-row-start: 3;
    }
    .oppstart1040 {
      grid-row-start: 4;
    }
    .oppstart1210 {
      grid-row-start: 5;
    }
    .klasseGrid {
      display: grid;
      grid-template-columns: repeat(3, minmax(4rem, 1fr));
      text-align: center;
    }
    .gruppeGrid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      text-align: center;
    }
    .IMA,
    .IMB,
    .IMC,
    .IMC,
    .IMY {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .fagbeholder {
      display: grid;
      grid-template-columns: auto 1fr min-content;
      text-align: center;
      align-items: center;
      margin-bottom: 0.3rem;
      margin-inline-end: 0.5rem;
    }
    /* FARGER */
    .programfag h3,
    .programfag h4 {
      color: var(--clr-safir);
    }
    .forum h3,
    .forum h4 {
      color: var(--clr-thulitt);
    }
    .naturfag h3,
    .naturfag h4 {
      color: var(--clr-smaragd);
    }
    .matte h3,
    .matte h4 {
      color: var(--clr-citrin);
    }
    .engelsk h3,
    .engelsk h4 {
      color: var(--clr-spessartin);
    }
    .kroppsoeving h3,
    .kroppsoeving h4 {
      color: var(--clr-amazonitt);
    }
    /* UTSEENDE */
    article {
      border-top-right-radius: clamp(0.2rem, 0.4rem, 0.6vw);
      border-top-left-radius: clamp(0.8rem, 1.2rem, 1.2vw);
      border-bottom-left-radius: clamp(0.2rem, 0.4rem, 0.6vw);
      border-bottom-right-radius: clamp(0.8rem, 1.2rem, 1.2vw);
      border-color: var(--clr-ramme);
      background-color: var(--clr-tekstBoks);
      border-width: 1px 1px 2px 2px;
      border-style: solid;
    }
    article p:first-of-type {
      margin-block-start: 0.5rem;
    }
    article p {
      padding-inline: 1rem;
    }
    /* INTERAKTIVITET */
    .enkel p,
    .dobbel p,
    .trippel p,
    .frippel p {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .enkel:has(h4) p {
      display: none;
    }
    .dobbel p {
      line-clamp: 5;
      -webkit-line-clamp: 5;
    }
    .trippel p {
      line-clamp: 10;
      -webkit-line-clamp: 10;
    }
    .frippel p {
      line-clamp: 15;
      -webkit-line-clamp: 15;
    }
    article:has(p) {
      cursor: pointer;
    }
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
    /* DIALOG */
    button {
      display: grid;
      align-items: start;
    }
    dialog {
      position: absolute;
      margin: auto;
      width: 500px;
      border-top-right-radius: clamp(0.2rem, 0.4rem, 0.6vw);
      border-top-left-radius: clamp(0.8rem, 1.2rem, 1.2vw);
      border-bottom-left-radius: clamp(0.2rem, 0.4rem, 0.6vw);
      border-bottom-right-radius: clamp(0.8rem, 1.2rem, 1.2vw);
      border-color: var(--clr-ramme);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
      z-index: 110;
    }
    dialog .fagbeholder {
      display: grid;
      grid-template-columns: auto 1fr auto;
      width: 100%;
      padding-inline-end: 1rem;
      align-items: center;
    }
    dialog::backdrop {
      background-color: Black;
      opacity: 0.4;
    }
    #lukk {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      padding-inline: 0.5rem;
      padding-block: 0rem;
    }
    dialog h1 {
      font-size: 2rem;
    }
    dialog h2 {
      font-size: 1.6rem;
    }
    dialog h3 {
      font-size: 1.4rem;
      text-align: center;
    }
    dialog h4 {
      font-size: 1.2rem;
    }
    dialog h5 {
      font-size: 1.1rem;
      margin-block-end: 1rem;
    }
    dialog h6 {
      width: min-content;
      font-size: 1rem;
    }
    dialog p {
      font-size: 1rem;
      margin-block-end: 2rem;
    }
    dialog .svgIkon {
      width: 70px;
      height: 70px;
    }
    dialog:has(.programdagIkon) h3,
    dialog:has(.programdagIkon) h4 {
      color: var(--clr-safir);
    }
    dialog:has(.forumfagIkon) h3,
    dialog:has(.forumfagIkon) h4 {
      color: var(--clr-thulitt);
    }
    dialog:has(.naturfagIkon) h3,
    dialog:has(.naturfagIkon) h4 {
      color: var(--clr-smaragd);
    }
    dialog:has(.matteIkon) h3,
    dialog:has(.matteIkon) h4 {
      color: var(--clr-citrin);
    }
    dialog:has(.engelskIkon) h3,
    dialog:has(.engelskIkon) h4 {
      color: var(--clr-spessartin);
    }
    dialog:has(.kroppsoevingIkon) h3,
    dialog:has(.kroppsoevingIkon) h4 {
      color: var(--clr-amazonitt);
    }
    dialog p {
      padding-inline: 1rem;
    }
  </style>
  <body>
    <header id="dager">
      <div class="mandag">
        <h2>Mandag</h2>
        <h4>1. september</h4>
      </div>
      <div class="tirsdag">
        <h2>Tirsdag</h2>
        <h4>2. september</h4>
      </div>
      <div class="onsdag">
        <h2>Onsdag</h2>
        <h4>3. september</h4>
      </div>
      <div class="torsdag">
        <h2>Torsdag</h2>
        <h4>4. september</h4>
      </div>
      <div class="fredag">
        <h2>Fredag</h2>
        <h4>5. september</h4>
      </div>
    </header>
    <main id="timeplan">
      <!-- MANDAG -->
      <section id="mandag">
        <article class="undervisning programfag trippel klasse oppstart0900"></article>
        <article class="undervisning programfag dobbel klasse MariusIMA"></article>
        <article class="undervisning programfag dobbel klasse MariusIMA"></article>
      </section>
      <!-- TIRSDAG -->
      <section id="tirsdag">
        <article class="undervisning forum enkel gruppe oppstart0900"><p></p></article>
        <article class="undervisning matte dobbel klasse"><p></p></article>
        <article class="undervisning naturfag dobbel gruppe"><p></p></article>
        <article class="undervisning engelsk trippel gruppe"><p></p></article>
      </section>
      <!-- ONSDAG -->
      <section id="onsdag">
        <article class="undervisning programfag dobbel klasse oppstart0955 MariusIMC"><p></p></article>
        <article class="undervisning programfag dobbel klasse MariusIMA"><p></p></article>
        <article class="undervisning programfag dobbel klasse MariusIMB"><p></p></article>
      </section>
      <!-- TORSDAG -->
      <section id="torsdag">
        <article class="undervisning programfag dobbel klasse oppstart0815 MariusIMA"><p></p></article>
        <article class="undervisning programfag dobbel klasse MariusIMB"><p></p></article>
        <article class="undervisning programfag trippel klasse"><p></p></article>
      </section>
      <!-- FREDAG -->
      <section id="fredag">
        <article class="undervisning programfag dobbel klasse oppstart0815 MariusIMC"><p></p></article>
        <article class="undervisning kroppsoeving dobbel gruppe"><p></p></article>
        <article class="undervisning matte enkel klasse"></article>
        <article class="undervisning engelsk dobbel gruppe"><p></p></article>
      </section>
    </main>
    <script>
      /* STATISK INNHOLD */
      // Konstanter (delte)
      const startPosisjon = { oppstart0815: 1, oppstart0900: 2, oppstart0955: 3 };
      const blokkVarighet = { enkel: 1, dobbel: 2, trippel: 3, frippel: 4 };

      const starttider = [
        { startRad: 1, tid: "08:15" },
        { startRad: 2, tid: "09:00" },
        { startRad: 3, tid: "09:55" },
        { startRad: 4, tid: "10:40" },
        { startRad: 5, tid: "12:10" },
        { startRad: 6, tid: "12:55" },
        { startRad: 7, tid: "13:50" },
        { startRad: 8, tid: "14:35" },
        { startRad: 9, tid: "15:30" },
      ];

      const sluttider = [
        { sluttRad: 2, tid: "09:00" },
        { sluttRad: 3, tid: "09:45" },
        { sluttRad: 4, tid: "10:40" },
        { sluttRad: 5, tid: "11:25" },
        { sluttRad: 6, tid: "12:55" },
        { sluttRad: 7, tid: "13:40" },
        { sluttRad: 8, tid: "14:35" },
        { sluttRad: 9, tid: "15:20" },
        { sluttRad: 10, tid: "16:15" },
      ];

      const fagNavn = {
        forum: "Forum",
        matte: "Matte",
        kroppsoeving: "Kroppsøving",
        engelsk: "Engelsk",
        naturfag: "Naturfag",
        tur: "Skoletur",
        programfag: "Programfag",
        standard: "fridag",
      };

      // --- Byggefunksjoner (små, fokuserte) ---

      function byggIkon(fagKey) {
        const ikon = document.createElement("div");
        ikon.classList.add("svgIkon");
        if (fagKey) ikon.classList.add(`${fagKey}Ikon`);
        return ikon;
      }

      function byggTittel(fagKey) {
        const h3 = document.createElement("h3");
        h3.textContent = fagNavn[fagKey] || fagNavn.standard;
        return h3;
      }

      function byggKlokke(startTid, sluttTid) {
        const h6 = document.createElement("h6");
        h6.textContent = startTid && sluttTid ? `${startTid} ${sluttTid}` : "";
        return h6;
      }

      function byggFagbeholder({ fagKey, startTid, sluttTid }) {
        const fagbeholder = document.createElement("div");
        fagbeholder.className = "fagbeholder";
        fagbeholder.appendChild(byggIkon(fagKey));
        fagbeholder.appendChild(byggTittel(fagKey));

        fagbeholder.appendChild(byggKlokke(startTid, sluttTid));
        return fagbeholder;
      }

      // --- Hjelpefunksjoner for beregning/logikk ---

      function finnSkolestart(dag) {
        let skolestart = 1;
        const startElement = dag.querySelector(".oppstart0815, .oppstart0900, .oppstart0955");
        if (startElement) {
          for (const klasseNavn of startElement.classList) {
            if (startPosisjon[klasseNavn]) {
              skolestart = startPosisjon[klasseNavn];
              break;
            }
          }
        }
        return skolestart;
      }

      function finnStartRad(undervisning, nesteRad) {
        // 1) eksplisitt startklasse
        for (const klasseNavn of undervisning.classList) {
          if (startPosisjon[klasseNavn]) return startPosisjon[klasseNavn];
        }
        // 2) CSS grid-row-start
        const cssStartverdi = getComputedStyle(undervisning).gridRowStart;
        const parset = parseInt(cssStartverdi, 10);
        if (!Number.isNaN(parset)) return parset;
        // 3) fallback
        return nesteRad;
      }

      function finnVarighet(undervisning) {
        return Array.from(undervisning.classList).reduce((span, klasseNavn) => blokkVarighet[klasseNavn] ?? span, 1);
      }

      function finnTider(startRad, antallRader) {
        const sluttRad = startRad + antallRader;
        const startTid = starttider.find((x) => x.startRad === startRad)?.tid || "";
        const sluttTid = sluttider.find((x) => x.sluttRad === sluttRad)?.tid || "";
        return { startTid, sluttTid, sluttRad };
      }

      function finnFagKey(undervisning) {
        return Array.from(undervisning.classList).find((klasse) => fagNavn[klasse]);
      }

      // --- Orkestrator ---

      function byggTimeplan() {
        const dager = document.querySelectorAll("#timeplan > section");

        dager.forEach((dag) => {
          let nesteRad = finnSkolestart(dag);
          const undervisningsblokker = dag.querySelectorAll(".undervisning");

          undervisningsblokker.forEach((undervisning) => {
            const startRad = finnStartRad(undervisning, nesteRad);
            const antallRader = finnVarighet(undervisning);
            const { startTid, sluttTid, sluttRad } = finnTider(startRad, antallRader);
            const fagKey = finnFagKey(undervisning);

            const fagbeholder = byggFagbeholder({ fagKey, startTid, sluttTid });
            undervisning.prepend(fagbeholder);

            nesteRad = sluttRad; // flytt cursor
          });
        });
      }

      function byggGrupper() {
        // Lærere for fag med klasser (IMA/B/C)
        const laerereKlasse = {
          programfag: { IMA: "Eirik", IMB: "Stian", IMC: "Jon" },
          matte: { IMA: "Sivert", IMB: "Lars Tore", IMC: "Mikkel" },
        };

        // Lærere for fag med grupper (IMX/Y)
        const laerereGruppe = {
          engelsk: { IMX: "Mari", IMY: "Kjetil" },
          kroppsoeving: { IMX: "Ajdin", IMY: "Laila Kristin" },
          naturfag: { IMX: "Thomas", IMY: "Sivert" },
        };

        // Bygg .klasse-elementer
        document.querySelectorAll(".klasse").forEach((element) => {
          const fagNavn = Object.keys(laerereKlasse).find((fag) => element.classList.contains(fag));

          // hopp over hvis ukjent fag
          if (!fagNavn) return;
          const klasseGrid = document.createElement("div");
          klasseGrid.className = "klasseGrid";
          Object.keys(laerereKlasse[fagNavn]).forEach((klasse) => {
            const div = document.createElement("div");
            div.className = klasse;
            const h4 = document.createElement("h4");
            h4.textContent = `1${klasse}`;
            const h5 = document.createElement("h5");
            h5.textContent = element.classList.contains(`Marius${klasse}`) ? "Marius" : laerereKlasse[fagNavn][klasse];
            div.append(h4, h5);
            klasseGrid.prepend(div);
          });
          element.prepend(klasseGrid);
        });

        // Bygg .gruppe-elementer
        document.querySelectorAll(".gruppe").forEach((element) => {
          const fagNavn = Object.keys(laerereGruppe).find((fag) => element.classList.contains(fag));

          // hopp over hvis ukjent fag
          if (!fagNavn) return;
          const gruppeGrid = document.createElement("div");
          gruppeGrid.className = "gruppeGrid";
          Object.keys(laerereGruppe[fagNavn]).forEach((gruppe) => {
            const div = document.createElement("div");
            div.className = gruppe;
            const h4 = document.createElement("h4");
            h4.textContent = gruppe;
            const h5 = document.createElement("h5");
            h5.textContent = laerereGruppe[fagNavn][gruppe];
            div.append(h4, h5);
            gruppeGrid.prepend(div);
          });
          element.prepend(gruppeGrid);
        });
      }

      // Konsturer timeplanen og elevinndelinger etter at DOM-elementene har lastet inn
      document.addEventListener("DOMContentLoaded", () => {
        byggGrupper();
        byggTimeplan();
      });

      /* INTERAKTIVITET */
      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("article").forEach((block) => {
          // Sjekk om det finnes minst ett p-element
          if (!block.querySelector("p")) {
            return; // hopp over hvis ingen <p> funnet
          }
          // Gjør <article> fokus- og tastaturvennlig
          block.setAttribute("role", "button");
          block.setAttribute("tabindex", "0");
          block.setAttribute("aria-haspopup", "dialog");
          const dialog = document.createElement("dialog");
          dialog.classList.add("undervisning-dialog");

          const innhold = document.createElement("div");
          innhold.classList.add("dialog-innhold");
          innhold.innerHTML = block.innerHTML;
          dialog.appendChild(innhold);

          const closeForm = document.createElement("form");
          closeForm.method = "dialog";
          closeForm.innerHTML = "<button id='lukk'>Lukk</button>";
          dialog.appendChild(closeForm);

          document.body.appendChild(dialog);

          const openDialog = () => dialog.showModal();
          block.addEventListener("click", openDialog);
          block.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              openDialog();
            }
          });

          // Lukk ved klikk på bakteppet
          dialog.addEventListener("click", (e) => {
            const padding = 16;
            const rect = dialog.querySelector(".dialog-innhold").getBoundingClientRect();
            const inDialog =
              e.clientX >= rect.left - padding && e.clientX <= rect.right + padding && e.clientY >= rect.top - padding && e.clientY <= rect.bottom + padding;

            if (!inDialog) dialog.close();
          });
        });
      });
    </script>
  </body>
</html>
